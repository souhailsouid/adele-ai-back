
openapi: 3.0.3
info:
  title: Adele ai Backend API
  description: |
    API complète pour l'analyse de données financières et d'options.
    
    Architecture modulaire en 3 couches :
    - **Ingestion** : Collecte rapide et idempotente des données externes
    - **Analyse unitaire** : Analyses par module (règles simples + IA)
    - **Synthèse globale** : Analyses combinées et insights avancés
  version: 1.0.0
  contact:
    name: Adele ai API Support
servers:
  - url: https://tsdd1sibd1.execute-api.eu-west-3.amazonaws.com/prod
    description: API Gateway 1 - Application Principale (`@baseUrlMain` dans `api-tests.http`)
  - url: https://faq9dl95v7.execute-api.eu-west-3.amazonaws.com/prod
    description: API Gateway 2 - Données Brutes FMP + Unusual Whales (`@baseUrlData` dans `api-tests.http`)

tags:
  - name: Ingestion
    description: Routes d'ingestion de données (Couche A - Collecte)
  - name: Analyse Unitaire
    description: Routes d'analyse par module (Couche B - Analyses unitaires)
  - name: Analyse IA
    description: Routes d'analyse avec Intelligence Artificielle
  - name: Analyse Combinée
    description: Analyses combinées multi-sources
  - name: FMP
    description: Routes Financial Modeling Prep (données financières)
  - name: Unusual Whales
    description: Routes Unusual Whales (options, dark pool, institutions)
  - name: Ticker Activity
    description: Activité et données de ticker
  - name: Scoring
    description: Calcul de scores et métriques
  - name: Surveillance
    description: Surveillance de tickers et alertes
  - name: Alerts
    description: Gestion des alertes personnalisées
  - name: Attribution
    description: Attribution de flows aux entités
  - name: Smart Money
    description: Analyse des smart money et hedge funds
  - name: Signals
    description: Gestion des signaux
  - name: Funds
    description: Gestion des fonds
  - name: Companies
    description: Gestion des entreprises

security:
  - bearerAuth: []

paths:
  # ============================================
  # INGESTION (Couche A)
  # ============================================
  /ingest/options-flow:
    post:
      tags: [Ingestion]
      summary: Ingérer les données d'options flow
      description: |
        Appelle l'API Unusual Whales, normalise et stocke les données dans Supabase.
        Pas de LLM, pas d'agrégation globale - juste collecte et stockage.
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: NVDA
          description: Symbole du ticker
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 30
          description: Nombre maximum de trades à récupérer
      responses:
        '200':
          description: Données ingérées avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  module:
                    type: string
                    example: options_flow
                  state:
                    $ref: '#/components/schemas/ModuleState'
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Paramètre manquant
        '500':
          description: Erreur serveur

  /ingest/options-flow-alerts:
    post:
      tags: [Ingestion]
      summary: Ingérer les flow alerts (option-trades/flow-alerts)
      description: |
        Appelle l'API Unusual Whales `/option-trades/flow-alerts`, normalise et stocke les données dans Supabase.
        Différent de `/ingest/options-flow` qui utilise `/stock/{ticker}/flow-recent`.
        
        Les flow alerts détectent les trades options inhabituels (gros blocs, sweeps, etc.).
        Les données sont stockées dans la table `options_flow` avec un flag `data->>source = 'flow_alerts'`.
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: FISV
          description: Symbole du ticker
        - name: min_premium
          in: query
          required: false
          schema:
            type: number
            format: float
            default: 1000000
          description: "Prime minimum en USD (défaut: 1M$)"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 200
          description: "Nombre maximum de flow alerts à récupérer (max: 200)"
        - name: newer_than
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Date/heure minimum (ISO 8601 ou Unix timestamp)
        - name: older_than
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Date/heure maximum (ISO 8601 ou Unix timestamp)
        - name: is_call
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les calls
        - name: is_put
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les puts
        - name: is_sweep
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les sweeps
        - name: is_floor
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les floor trades
      responses:
        '200':
          description: Flow alerts ingérées avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  ticker:
                    type: string
                    example: FISV
                  module:
                    type: string
                    example: options_flow_alerts
                  state:
                    $ref: '#/components/schemas/ModuleState'
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Paramètre manquant ou invalide
        '500':
          description: Erreur serveur

  /ingest/flow-alerts:
    post:
      tags: [Ingestion]
      summary: Ingérer les flow alerts dans la table flow_alerts (pour analyse pro)
      description: |
        **NOUVEAU** : Route d'ingestion dédiée pour l'analyse pro du flow options.
        
        Appelle l'API Unusual Whales `/option-trades/flow-alerts`, normalise et stocke les données dans la table `flow_alerts`.
        Cette route est **indispensable avant** d'utiliser `/ai/flow-options-analysis-pro` pour éviter les cold starts et latences.
        
        **Différence avec `/ingest/options-flow-alerts`** :
        - Cette route stocke dans `flow_alerts` (table dédiée pour l'analyse pro)
        - `/ingest/options-flow-alerts` stocke dans `options_flow` avec un flag
        
        **Workflow recommandé** :
        1. `POST /ingest/flow-alerts?ticker=MSFT` (ingestion)
        2. `POST /ai/flow-options-analysis-pro` avec `{"ticker": "MSFT"}` (analyse depuis DB)
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: MSFT
          description: Symbole du ticker
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
          description: "Nombre maximum de flow alerts à récupérer (max: 200)"
        - name: min_premium
          in: query
          required: false
          schema:
            type: number
            format: float
            default: 10000
          description: "Prime minimum en USD (défaut: 10k$)"
        - name: is_call
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les calls
        - name: is_put
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les puts
        - name: is_sweep
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les sweeps
        - name: is_floor
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Inclure les floor trades
      responses:
        '200':
          description: Flow alerts ingérées avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  ticker:
                    type: string
                    example: MSFT
                  module:
                    type: string
                    example: flow_alerts
                  count:
                    type: integer
                    example: 15
                    description: Nombre de flow alerts ingérées
                  state:
                    $ref: '#/components/schemas/ModuleState'
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Paramètre manquant ou invalide
        '500':
          description: Erreur serveur

  /ingest/option-contracts-daily:
    post:
      tags: [Ingestion]
      summary: Ingérer les données journalières de tous les contrats d'options pour un ticker
      description: |
        **ESSENTIEL** : Cette route remplit la table `option_contract_daily` nécessaire pour `/uoa/detect-unusual`.
        
        **Fonctionnement** :
        1. Récupère tous les contrats du jour via `/stock/{ticker}/option-contracts`
        2. Pour chaque contrat, récupère le volume-profile pour la date via `/option-contract/{id}/volume-profile`
        3. Agrège les données journalières (volume, ask, bid, multi, premium, etc.)
        4. Stocke dans `option_contract_daily` (table pour les statistiques historiques)
        
        **Utilisation** :
        - Pour une date spécifique : `?ticker=FISV&date=2025-12-18`
        - Pour aujourd'hui : `?ticker=FISV` (date optionnelle)
        - Pour un range : `?ticker=FISV&start_date=2025-12-01&end_date=2025-12-18`
        
        **Important** : Cette ingestion doit être faite AVANT d'utiliser `/uoa/detect-unusual` pour avoir les données historiques nécessaires au calcul des z-scores.
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: FISV
          description: Symbole du ticker
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
            example: "2025-12-18"
          description: "Date à ingérer (format YYYY-MM-DD, défaut: aujourd'hui)"
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
            example: "2025-12-01"
          description: "Date de début pour un range (format YYYY-MM-DD, utilisé avec end_date)"
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
            example: "2025-12-18"
          description: "Date de fin pour un range (format YYYY-MM-DD, utilisé avec start_date)"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 500
          description: "Nombre maximum de contrats à traiter (défaut: 500, max: 1000)"
      responses:
        '200':
          description: Données journalières ingérées avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  ticker:
                    type: string
                    example: FISV
                  dates_processed:
                    type: array
                    items:
                      type: string
                      format: date
                    example: ["2025-12-18"]
                    description: Dates traitées
                  contracts_ingested:
                    type: integer
                    example: 45
                    description: Nombre de contrats ingérés (nouvelles données)
                  contracts_skipped:
                    type: integer
                    example: 10
                    description: Nombre de contrats ignorés (déjà en base)
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-12-18T15:00:00Z"
        '400':
          description: Paramètre manquant ou invalide
        '500':
          description: Erreur serveur

  /ingest/options-volume:
    post:
      tags: [Ingestion]
      summary: Ingérer les données d'options volume
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Données ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/dark-pool:
    post:
      tags: [Ingestion]
      summary: Ingérer les données de dark pool
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 30
      responses:
        '200':
          description: Données ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/short-interest:
    post:
      tags: [Ingestion]
      summary: Ingérer les données de short interest
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Données ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/price-action:
    post:
      tags: [Ingestion]
      summary: Ingérer les données de price action (quote)
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Données ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/earnings:
    post:
      tags: [Ingestion]
      summary: Ingérer les earnings historiques d'un ticker (UW /earnings/{ticker})
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: NVDA)"
      responses:
        '200':
          description: Données ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/price-context:
    post:
      tags: [Ingestion]
      summary: Ingérer un contexte prix minimal (spot + SMA20/50 + range 5j)
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: NVDA)"
      responses:
        '200':
          description: Données ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/oi-change:
    post:
      tags: [Ingestion]
      summary: Ingérer les données d'OI Change (par contrat)
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: NVDA)"
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Date de trading (YYYY-MM-DD), optionnelle.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [desc, asc]
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
      responses:
        '200':
          description: Données d'OI Change ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/oi-per-strike:
    post:
      tags: [Ingestion]
      summary: Ingérer les données d'OI per strike
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Données d'OI per strike ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/iv-rank:
    post:
      tags: [Ingestion]
      summary: Ingérer les données d'IV Rank
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: timespan
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Données d'IV Rank ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/greeks:
    post:
      tags: [Ingestion]
      summary: Ingérer les Greeks agrégés (gamma/delta exposure par strike)
      description: |
        Appelle Unusual Whales (greek exposure) et stocke un bloc agrégé "gamma map" :
        - net gamma exposure
        - net delta exposure
        - top strikes par gamma (valeur absolue)
        IMPORTANT : ces données servent à qualifier le contexte (pin/walls), pas à générer des signaux.
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: NVDA
          description: "Symbole du ticker (ex: NVDA)"
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: "Date de trading (YYYY-MM-DD), optionnelle."
        - name: force
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: "Forcer la ré-ingestion même si le module est encore considéré 'fresh' (debug)."
      responses:
        '200':
          description: Données de greeks ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/max-pain:
    post:
      tags: [Ingestion]
      summary: Ingérer les données de Max Pain
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Données de Max Pain ingérées avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'

  /ingest/all:
    post:
      tags: [Ingestion]
      summary: Ingérer plusieurs modules en parallèle
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
        - name: modules
          in: query
          required: false
          schema:
            type: string
            example: options_flow,dark_pool,short_interest
          description: Liste de modules séparés par des virgules
      responses:
        '200':
          description: Modules ingérés avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  modules:
                    type: object
                    additionalProperties:
                      $ref: '#/components/schemas/ModuleState'
                  timestamp:
                    type: string
                    format: date-time

  /ingest/status:
    get:
      tags: [Ingestion]
      summary: Récupérer l'état de tous les modules d'un ticker
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: État des modules
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  modules:
                    type: array
                    items:
                      $ref: '#/components/schemas/ModuleState'
                  timestamp:
                    type: string
                    format: date-time

  # ============================================
  # ANALYSE UNITAIRE (Couche B)
  # ============================================
  /analyze/options-flow:
    post:
      tags: [Analyse Unitaire]
      summary: Analyser le module options_flow (analyse unitaire + IA)
      description: |
        Lit les données depuis Supabase et fait une analyse combinée :
        - Analyse unitaire (règles simples)
        - Analyse IA (si les données sont disponibles)
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: NVDA
      responses:
        '200':
          description: Analyse complète
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  module:
                    type: string
                    example: options_flow
                  unit_analysis:
                    $ref: '#/components/schemas/UnitAnalysisResult'
                  ai_analysis:
                    $ref: '#/components/schemas/AIAnalysis'
                  metrics:
                    type: object
                    properties:
                      call_put_ratio:
                        type: number
                      total_premium:
                        type: number
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Paramètre manquant
        '404':
          description: Aucune donnée disponible (ingérer d'abord avec POST /ingest/options-flow)

  /analyze/dark-pool:
    post:
      tags: [Analyse Unitaire]
      summary: Analyser le module dark_pool
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Analyse dark pool
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  module:
                    type: string
                  analysis:
                    $ref: '#/components/schemas/UnitAnalysisResult'
                  timestamp:
                    type: string
                    format: date-time

  /analyze/all:
    post:
      tags: [Analyse Unitaire]
      summary: Analyser plusieurs modules en parallèle
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
        - name: modules
          in: query
          required: false
          schema:
            type: string
            example: options_flow,dark_pool
      responses:
        '200':
          description: Analyses multiples
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  analyses:
                    type: object
                    additionalProperties:
                      $ref: '#/components/schemas/UnitAnalysisResult'
                  timestamp:
                    type: string
                    format: date-time

  /analyze/results:
    get:
      tags: [Analyse Unitaire]
      summary: Récupérer les résultats d'analyses unitaires
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
        - name: modules
          in: query
          required: false
          schema:
            type: string
            example: options_flow,dark_pool
      responses:
        '200':
          description: Résultats des analyses
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  analyses:
                    type: array
                    items:
                      $ref: '#/components/schemas/UnitAnalysisResult'
                  timestamp:
                    type: string
                    format: date-time

  # ============================================
  # ANALYSE IA
  # ============================================
  /ai/calendar-summary:
    post:
      tags: [Analyse IA]
      summary: Analyser un calendrier d'événements (FDA, Earnings, etc.)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                from:
                  type: string
                  format: date
                  example: "2025-12-01"
                to:
                  type: string
                  format: date
                  example: "2025-12-31"
      responses:
        '200':
          description: Analyse du calendrier
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/options-flow-analysis:
    post:
      tags: [Analyse IA]
      summary: Analyser un flux d'options inhabituel
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
                  example: NVDA
                signal_type:
                  type: string
                  enum: [unusual_options_flow, gamma_squeeze, dark_pool_spike, insider_activity]
                  default: unusual_options_flow
                metrics:
                  type: object
                  properties:
                    call_put_ratio:
                      type: number
                    total_premium:
                      type: number
                    biggest_trade:
                      type: object
                raw_data:
                  type: array
                  items:
                    type: object
      responses:
        '200':
          description: Analyse du flux d'options
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/flow-options-analysis-pro:
    post:
      tags: [Analyse IA]
      summary: Analyse professionnelle du flow options (méthodologie pro)
      description: |
        **NOUVEAU** : Analyse professionnelle des flow options selon la méthodologie d'un analyste de marché.
        
        Transforme des données brutes de flow options en un raisonnement structuré et actionnable.
        Analyse 4 points : Importance, Intention du marché, Crédibilité, Conclusion opérationnelle.
        
        **Deux modes d'utilisation** :
        
        1. **Mode DB (Recommandé)** : Lit depuis la table `flow_alerts` (évite cold starts)
           - Fournir `ticker` dans le body
           - Les données doivent être ingérées avec `POST /ingest/flow-alerts` au préalable
        
        2. **Mode Direct** : Utilise les signals fournis directement
           - Fournir `signals` array dans le body
        
        **Important** : Pour utiliser le mode DB, ingérer d'abord avec `POST /ingest/flow-alerts?ticker=MSFT`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ticker:
                  type: string
                  example: MSFT
                  description: "Ticker à analyser (mode DB). Si fourni, lit depuis flow_alerts."
                signals:
                  type: array
                  items:
                    $ref: '#/components/schemas/FlowOptionsSignal'
                  description: "Signals à analyser (mode direct). Priorité sur ticker si fourni."
                limit:
                  type: integer
                  minimum: 1
                  maximum: 50
                  default: 10
                  description: "Nombre de signals à analyser depuis la DB (mode DB uniquement)"
                min_premium:
                  type: number
                  default: 50000
                  description: "Prime minimum pour filtrer depuis la DB (mode DB uniquement)"
                context:
                  type: object
                  properties:
                    days_to_earnings:
                      type: integer
                      description: "Jours jusqu'aux prochains earnings"
                    price_trend:
                      type: string
                      enum: [up, down, neutral]
                      description: "Tendance du prix"
                    recent_news:
                      type: array
                      items:
                        type: string
                      description: "News récentes pertinentes"
      responses:
        '200':
          description: Analyse professionnelle du flow options
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FlowOptionsAnalysisProResponse'
        '400':
          description: Paramètre manquant ou invalide
        '500':
          description: Erreur serveur

  /ai/institution-moves-analysis:
    post:
      tags: [Analyse IA]
      summary: Analyser les mouvements institutionnels
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
                calculated_metrics:
                  type: object
      responses:
        '200':
          description: Analyse des mouvements institutionnels
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/ticker-activity-analysis:
    post:
      tags: [Analyse IA]
      summary: Analyse complète de l'activité d'un ticker
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
                modules:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Analyse complète de l'activité
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/ticker-options-analysis:
    post:
      tags: [Analyse IA]
      summary: Analyse approfondie des options (OI changes, IV, Greeks, Max Pain, Volume Profile)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
      responses:
        '200':
          description: Analyse approfondie des options
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/options-unusual-activity:
    post:
      tags: [Analyse IA]
      summary: Détecter et analyser les trades options inhabituels (Unusual Options Activity - UOA)
      description: |
        Détecte les paris directionnels massifs et spécifiques (ex: 88k PUT Jan 65 pour 16M$).
        
        **Différent de l'analyse structurelle** qui regarde OI, gamma, zones.
        Ici on cherche des trades précis, volumineux, directionnels.
        
        **Important** : Les données doivent être ingérées d'abord avec `POST /ingest/options-flow-alerts`.
        Cette route lit depuis la base de données (pas d'appel API direct).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
                  example: FISV
                  description: Symbole du ticker
                lookback_days:
                  type: integer
                  minimum: 1
                  maximum: 30
                  default: 3
                  description: Nombre de jours à regarder en arrière
                min_premium_usd:
                  type: number
                  format: float
                  default: 1000000
                  description: "Prime minimum en USD pour qu'un trade soit considéré (défaut: 1M$)"
                min_volume_multiplier:
                  type: number
                  format: float
                  default: 5
                  description: "Multiplicateur minimum vs volume moyen pour qu'un trade soit inhabituel (défaut: 5x)"
      responses:
        '200':
          description: Analyse des trades options inhabituels
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  ticker:
                    type: string
                    example: FISV
                  unusual_options_activity:
                    type: array
                    items:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: [PUT BUY, PUT SELL, CALL BUY, CALL SELL]
                          example: PUT BUY
                        expiration:
                          type: string
                          format: date
                          example: "2025-01-17"
                        strike:
                          type: number
                          example: 65
                        contracts:
                          type: integer
                          example: 88000
                        premium_usd:
                          type: number
                          format: float
                          example: 16000000
                        trade_size_vs_avg:
                          type: string
                          example: "12.0x"
                        directional_bias:
                          type: string
                          enum: [bullish, bearish]
                          example: bearish
                        description:
                          type: string
                          example: "Un trade inhabituel a été détecté..."
                        timestamp:
                          type: string
                          format: date-time
                        option_symbol:
                          type: string
                        pct_of_daily_volume:
                          type: number
                          format: float
                  analysis:
                    type: object
                    properties:
                      observation:
                        type: string
                      attention_level:
                        type: string
                        enum: [faible, moyen, élevé, critique]
                      key_insights:
                        type: array
                        items:
                          type: object
                          properties:
                            insight:
                              type: string
                            impact:
                              type: string
                              enum: [faible, moyen, élevé, critique]
                            evidence:
                              type: string
                      context_with_structure:
                        type: string
                      warnings:
                        type: array
                        items:
                          type: string
                  metadata:
                    type: object
                    properties:
                      lookback_days:
                        type: integer
                      min_premium_usd:
                        type: number
                      total_trades_analyzed:
                        type: integer
                      data_quality:
                        type: object
                        properties:
                          flow_alerts_available:
                            type: boolean
                          volume_profile_available:
                            type: boolean
                          expiry_breakdown_available:
                            type: boolean
                  cached:
                    type: boolean
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Paramètre manquant ou invalide
        '404':
          description: Aucune donnée disponible (ingérer d'abord avec POST /ingest/options-flow-alerts)
        '500':
          description: Erreur serveur

  /ai/option-contract/accumulation:
    post:
      tags: [Analyse IA]
      summary: Analyser l'accumulation d'un contrat d'option sur une période
      description: |
        Analyse l'accumulation d'un contrat d'option spécifique sur une fenêtre temporelle donnée.
        Reconstruit ce que fait la vidéo : volume cumulé, premium cumulé, ask/bid/multi-leg, label "accumulation".
        
        **Fonctionnalités** :
        - Agrège les données de volume profile pour chaque jour de trading dans la fenêtre
        - Calcule le volume total, premium estimé, jours actifs
        - Calcule les ratios ask/bid/multi-leg
        - Génère un score d'accumulation et un label (low/medium/high)
        
        **Utilisation** :
        - Pour analyser un contrat spécifique (ex: FISV260220P00065000) sur 90 jours
        - Pour détecter l'accumulation progressive d'un strike/expiry
        - Pour comparer différents contrats sur la même période
        
        **Note** : La fenêtre maximale est de 90 jours pour éviter les timeouts.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - option_chain
                - start_date
                - end_date
              properties:
                option_chain:
                  type: string
                  example: "FISV260220P00065000"
                  description: "Symbole d'option au format ISO (TICKER + YYMMDD + C/P + STRIKE)"
                start_date:
                  type: string
                  format: date
                  example: "2025-10-01"
                  description: "Date de début de la fenêtre d'analyse (format YYYY-MM-DD)"
                end_date:
                  type: string
                  format: date
                  example: "2025-12-31"
                  description: "Date de fin de la fenêtre d'analyse (format YYYY-MM-DD, max 90 jours après start_date)"
      responses:
        '200':
          description: Analyse d'accumulation réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  option_chain:
                    type: string
                    example: "FISV260220P00065000"
                  start_date:
                    type: string
                    format: date
                    example: "2025-10-01"
                  end_date:
                    type: string
                    format: date
                    example: "2025-12-31"
                  accumulation:
                    type: object
                    properties:
                      total_contracts:
                        type: integer
                        example: 88000
                        description: "Nombre total de contrats échangés sur la période"
                      total_premium_est_usd:
                        type: number
                        format: float
                        example: 16000000
                        description: "Premium total estimé en USD (estimation: price * volume * 100)"
                      days_active:
                        type: integer
                        example: 45
                        description: "Nombre de jours actifs (avec volume > 0)"
                      multi_share:
                        type: number
                        format: float
                        example: 0.057
                        description: "Ratio multi-leg (0-1). Si élevé (>0.6), prudence (beaucoup de spreads/rolls)"
                      ask_share:
                        type: number
                        format: float
                        example: 0.568
                        description: "Ratio ask (0-1)"
                      bid_share:
                        type: number
                        format: float
                        example: 0.432
                        description: "Ratio bid (0-1)"
                      accumulation_score:
                        type: integer
                        example: 3
                        description: "Score d'accumulation (déterministe)"
                      accumulation_label:
                        type: string
                        enum: [low, medium, high]
                        example: high
                        description: "Label d'accumulation basé sur le score"
                  cached:
                    type: boolean
                    example: false
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-12-18T15:00:00Z"
        '400':
          description: "Paramètre manquant ou invalide (dates invalides, fenêtre > 90 jours)"
        '500':
          description: Erreur serveur

  /uoa/find-contracts:
    get:
      tags: [Analyse IA]
      summary: Trouver les contrats d'options correspondant à des critères
      description: |
        Trouve les contrats d'options correspondant à des critères spécifiques (strike, type, expiry).
        Utile pour retrouver le bon contrat avant d'analyser l'accumulation.
        
        **Utilisation** :
        - Pour trouver les PUT 65 autour de janvier 2026 pour FISV
        - Pour lister tous les contrats correspondant à un strike/type/expiry
        - Pour identifier le bon `option_symbol` avant d'appeler `/ai/option-contract/accumulation`
        
        **Fonctionnement** :
        1. Appelle l'endpoint UW `/stock/{ticker}/option-contracts` avec les filtres disponibles
        2. Parse les `option_symbol` pour extraire le strike et l'expiry
        3. Filtre par strike (avec tolérance de 0.5)
        4. Filtre par expiry (avec fenêtre de tolérance)
        5. Retourne les contrats triés par proximité de l'expiry cible
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: FISV
          description: Symbole du ticker
        - name: strike
          in: query
          required: true
          schema:
            type: number
            format: float
            example: 65
          description: Prix de strike recherché
        - name: option_type
          in: query
          required: true
          schema:
            type: string
            enum: [call, put]
            example: put
          description: Type d'option (call ou put)
        - name: expiry_target
          in: query
          required: true
          schema:
            type: string
            format: date
            example: "2026-01-16"
          description: Date d'expiration cible (format YYYY-MM-DD)
        - name: expiry_tolerance
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 7
          description: "Nombre de jours de tolérance autour de l'expiry cible (défaut: 7)"
      responses:
        '200':
          description: Contrats trouvés avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  ticker:
                    type: string
                    example: FISV
                  search_criteria:
                    type: object
                    properties:
                      strike:
                        type: number
                        example: 65
                      option_type:
                        type: string
                        example: put
                      expiry_target:
                        type: string
                        format: date
                        example: "2026-01-16"
                      expiry_tolerance_days:
                        type: integer
                        example: 7
                  contracts:
                    type: array
                    items:
                      type: object
                      properties:
                        option_symbol:
                          type: string
                          example: FISV260220P00065000
                          description: Symbole d'option au format ISO
                        strike:
                          type: number
                          example: 65
                          description: Strike parsé depuis le symbole
                        expiry:
                          type: string
                          format: date
                          example: "2026-02-20"
                          description: Date d'expiration parsée depuis le symbole
                        expiry_days_from_target:
                          type: integer
                          example: 35
                          description: Nombre de jours entre l'expiry et la cible (négatif si avant)
                        volume:
                          type: integer
                          example: 88000
                        open_interest:
                          type: integer
                          example: 125000
                        total_premium:
                          type: string
                          example: "16000000.00"
                        last_price:
                          type: string
                          example: "0.18"
                        implied_volatility:
                          type: string
                          example: "0.25"
                  count:
                    type: integer
                    example: 1
                    description: Nombre de contrats trouvés
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-12-18T15:00:00Z"
        '400':
          description: Paramètre manquant ou invalide
        '500':
          description: Erreur serveur

  /uoa/detect-unusual:
    get:
      tags: [Analyse IA]
      summary: Détecter objectivement les volumes inhabituels (daily scanner)
      description: |
        Détecte objectivement les volumes d'options inhabituels pour un ticker, quel que soit le ticker.
        Utilise une méthodologie professionnelle basée sur la normalisation statistique.
        
        **Méthodologie (5 piliers)** :
        1. **Normalisation par contexte** : Compare à la moyenne 30j/90j du même contrat
        2. **Z-score statistique** : z > 2 = notable, z > 3 = inhabituel, z > 4 = exceptionnel
        3. **Volume/OI ratio** : < 0.3 = churn, 0.5-1.0 = activité réelle, > 1.0 = nouvelle position
        4. **Ask/Bid + structure** : ask_share > 60% = achat agressif, multi-leg élevé = prudence
        5. **Scoring déterministe** : +2 si z > 3, +1 si vol/OI > 0.7, +1 si ask/bid > 60%, -1 si multi-leg > 60%
        
        **Labels** :
        - `normal` : Score 0-1
        - `notable` : Score 2
        - `unusual` : Score 3
        - `exceptional` : Score 4+
        
        **Important** : Un volume inhabituel n'est PAS un gros chiffre absolu, c'est une anomalie statistique contextualisée.
        Exemple : 1M$ sur NVDA ≠ inhabituel, mais 200k$ sur une small cap peut l'être.
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: FISV
          description: Symbole du ticker
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
            example: "2025-12-18"
          description: "Date à analyser (format YYYY-MM-DD, défaut: aujourd'hui)"
        - name: lookback_days
          in: query
          required: false
          schema:
            type: integer
            minimum: 30
            maximum: 180
            default: 90
          description: "Période de référence pour les statistiques (30, 60, ou 90 jours)"
        - name: min_z_score
          in: query
          required: false
          schema:
            type: number
            format: float
            minimum: 0
            default: 2
          description: "Seuil minimum de z-score pour inclure un contrat (défaut: 2)"
      responses:
        '200':
          description: Détection réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  ticker:
                    type: string
                    example: FISV
                  date:
                    type: string
                    format: date
                    example: "2025-12-18"
                  unusual_contracts:
                    type: array
                    items:
                      type: object
                      properties:
                        option_symbol:
                          type: string
                          example: FISV260220P00065000
                        strike:
                          type: number
                          example: 65
                        expiry:
                          type: string
                          format: date
                          example: "2026-02-20"
                        volume_today:
                          type: integer
                          example: 5000
                        premium_today:
                          type: number
                          example: 1600000
                        open_interest:
                          type: integer
                          example: 3000
                        volume_oi_ratio:
                          type: number
                          example: 1.67
                          description: "Volume/OI ratio (> 1.0 = nouvelle position probable)"
                        ask_share:
                          type: number
                          example: 0.75
                          description: "Ratio ask (0-1, > 0.6 = achat agressif)"
                        bid_share:
                          type: number
                          example: 0.25
                        multi_leg_share:
                          type: number
                          example: 0.1
                          description: "Ratio multi-leg (0-1, > 0.6 = prudence)"
                        sweep_volume:
                          type: integer
                          example: 2000
                        stats_30d:
                          type: object
                          properties:
                            mean_volume:
                              type: number
                              example: 200
                            std_volume:
                              type: number
                              example: 150
                            z_score_volume:
                              type: number
                              example: 6.0
                              description: "Z-score volume (30 jours)"
                        stats_90d:
                          type: object
                          properties:
                            mean_volume:
                              type: number
                              example: 180
                            std_volume:
                              type: number
                              example: 120
                            z_score_volume:
                              type: number
                              example: 6.5
                              description: "Z-score volume (90 jours)"
                        unusual_score:
                          type: integer
                          example: 4
                          description: "Score déterministe (0-4+)"
                        label:
                          type: string
                          enum: [normal, notable, unusual, exceptional]
                          example: exceptional
                  summary:
                    type: object
                    properties:
                      total_contracts_scanned:
                        type: integer
                        example: 150
                      unusual_count:
                        type: integer
                        example: 5
                      notable_count:
                        type: integer
                        example: 3
                      exceptional_count:
                        type: integer
                        example: 2
                      total_premium_unusual:
                        type: number
                        example: 8000000
                  cached:
                    type: boolean
                    example: false
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-12-18T15:00:00Z"
        '400':
          description: Paramètre manquant ou invalide
        '500':
          description: Erreur serveur

  /uoa/top:
    get:
      tags: [Analyse IA]
      summary: Récupérer les top unusual trades (sans analyse IA, données brutes triées)
      description: |
        ✅ RECO 6: Endpoint clean pour les top trades inhabituels.
        
        Retourne les trades options inhabituels triés par premium, sans analyse IA.
        Utile pour avoir une vue rapide des plus gros paris directionnels.
        
        **3 modes prédéfinis :**
        - `strict`: min_premium=1M$, sweep OU floor, limit=200 (institutionnel)
        - `broad`: min_premium=500k$, pas de filtre, limit=300 (large)
        - `single_trade`: min_premium=5M$, pas de filtre, limit=500, lookback=30j (YouTube style)
        
        **Important** : Les données doivent être ingérées d'abord avec `POST /ingest/options-flow-alerts`.
      parameters:
        - name: ticker
          in: query
          required: true
          schema:
            type: string
            example: FISV
          description: Symbole du ticker
        - name: lookback_days
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 90
            default: 7
          description: "Nombre de jours à regarder en arrière"
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [strict, broad, single_trade]
            default: broad
          description: "Mode de filtrage (strict=institutionnel, broad=large, single_trade=YouTube style)"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 200
          description: "Nombre maximum de trades à retourner"
      responses:
        '200':
          description: Top unusual trades récupérés avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  ticker:
                    type: string
                    example: FISV
                  mode:
                    type: string
                    example: broad
                  lookback_days:
                    type: integer
                    example: 30
                  summary:
                    type: object
                    properties:
                      total_premium:
                        type: number
                        format: float
                        example: 50000000
                      nb_alerts:
                        type: integer
                        example: 15
                      call_put_ratio:
                        type: number
                        format: float
                        example: 0.3
                      call_count:
                        type: integer
                        example: 3
                      put_count:
                        type: integer
                        example: 12
                      distribution_expiries:
                        type: object
                        additionalProperties:
                          type: integer
                        example:
                          "2025-01-17": 5
                          "2025-02-21": 10
                  top_trades:
                    type: array
                    items:
                      type: object
                      properties:
                        option_chain:
                          type: string
                          example: FISV250117P00065000
                        type:
                          type: string
                          example: PUT BUY
                        strike:
                          type: number
                          example: 65
                        expiry:
                          type: string
                          format: date
                          example: "2025-01-17"
                        contracts:
                          type: integer
                          example: 88000
                        premium_usd:
                          type: number
                          format: float
                          example: 16000000
                        tape_bias:
                          type: string
                          enum: [ask_dominant, bid_dominant, mixed, unclear]
                          example: ask_dominant
                        directional_bias:
                          type: string
                          enum: [bullish, bearish]
                          example: bearish
                        has_sweep:
                          type: boolean
                          example: true
                        has_floor:
                          type: boolean
                          example: false
                        created_at:
                          type: string
                          format: date-time
                        alert_rule:
                          type: string
                        volume_oi_ratio:
                          type: number
                          format: float
                        underlying_price:
                          type: number
                          format: float
                  cached:
                    type: boolean
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Paramètre manquant ou invalide
        '404':
          description: Aucune donnée disponible (ingérer d'abord avec POST /ingest/options-flow-alerts)
        '500':
          description: Erreur serveur

  /ai/ticker-institutional-analysis:
    post:
      tags: [Analyse IA]
      summary: Analyser l'activité institutionnelle d'un ticker
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
      responses:
        '200':
          description: Analyse institutionnelle
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/options-five-factors:
    post:
      tags: [Analyse IA]
      summary: Analyse options basée sur 5 facteurs (flows, OI, IV, Max Pain)
      description: >
        Analyse avancée des options pour un ticker en utilisant cinq blocs de données
        déjà ingestés et structurés par le backend :
        - Recent Flows (options_flow)
        - OI Change (oi_change)
        - OI per Strike (oi_per_strike)
        - IV Rank (iv_rank)
        - Greeks / Exposure (greeks)
        - Max Pain (max_pain)
        - Price Context (ticker_price_context, FMP)
        - Catalysts (earnings timing via ticker_earnings)
        - Dark Pool (dark_pool_trades)

        L'IA n'invente AUCUNE donnée : elle interprète uniquement les métriques
        réellement présentes dans les tables d'ingestion.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ticker:
                  type: string
                  description: "Symbole du ticker (ex: NVDA, TSLA)"
              required: [ticker]
      responses:
        '200':
          description: Analyse des 5 facteurs d'options
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  data:
                    $ref: '#/components/schemas/OptionsFiveFactorsData'
                  analysis:
                    $ref: '#/components/schemas/OptionsFiveFactorsAnalysisResponse'
                  timestamp:
                    type: string
                    format: date-time

  /ai/options-analysis:
    post:
      tags: [Analyse IA]
      summary: Rapport options lisible (A→I) à partir du JSON consolidé
      description: >
        Prend en entrée le JSON consolidé (typiquement la réponse complète de
        POST /ai/options-five-factors) et produit un rapport en français structuré A→I
        (niveaux, risques, contexte) avec traçabilité des métriques.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ticker:
                  type: string
                  description: "Optionnel: override du ticker"
                payload:
                  type: object
                  description: "Objet JSON à analyser (ex: réponse de /ai/options-five-factors)"
              required: [payload]
      responses:
        '200':
          description: Rapport options
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  analysis:
                    type: object
                    properties:
                      ticker:
                        type: string
                      as_of:
                        type: string
                        nullable: true
                      spot:
                        type: number
                        nullable: true
                      bias:
                        type: string
                        enum: [bullish, bearish, neutral]
                      signal_quality:
                        type: string
                        enum: [faible, moyenne, forte]
                      contradictions:
                        type: array
                        items: { type: string }
                      key_levels:
                        type: array
                        items: { type: string }
                      key_levels_structured:
                        type: object
                        properties:
                          pivot: { type: string, nullable: true }
                          resistance: { type: string, nullable: true }
                          risk_zone: { type: string, nullable: true }
                      report:
                        type: string
                      cached:
                        type: boolean
                      timestamp:
                        type: string
                        format: date-time
                  timestamp:
                    type: string
                    format: date-time

  /ai/market-risk-overlay:
    post:
      tags: [Analyse IA]
      summary: Macro risk overlay (exogenous) based on economic calendar
      description: >
        Reads the upcoming macro-economic calendar over a lookahead horizon and returns a non-directional
        exogenous risk overlay. Does NOT modify the provided options analysis.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ticker:
                  type: string
                options_analysis:
                  type: object
                  description: "Full output of POST /ai/options-analysis"
                lookahead_days:
                  type: number
                  description: "Horizon in days (e.g. 3, 5, 7)"
                focus_topics:
                  type: array
                  items: { type: string }
                  description: "Optional human-in-the-loop themes to evaluate (no invention)."
              required: [ticker, options_analysis, lookahead_days]
      responses:
        '200':
          description: Macro risk overlay
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  analysis:
                    type: object
                    properties:
                      ticker: { type: string }
                      lookahead_days: { type: number }
                      macro_risk_overlay:
                        type: object
                        properties:
                          has_risk: { type: boolean }
                          risk_level: { type: string, enum: [low, medium, high] }
                          events:
                            type: array
                            items:
                              type: object
                              properties:
                                event: { type: string }
                                date: { type: string }
                                category:
                                  type: string
                                  enum: [central_bank, inflation, jobs, growth, geopolitics, rates, liquidity, other]
                                risk_channel: { type: string }
                                confidence: { type: string, enum: [low, medium, high] }
                                note: { type: string }
                          themes:
                            type: object
                            properties:
                              requested:
                                type: array
                                items: { type: string }
                              assessments:
                                type: array
                                items:
                                  type: object
                                  properties:
                                    topic: { type: string }
                                    status: { type: string, enum: [corroborated, not_corroborated] }
                                    confidence: { type: string, enum: [low, medium, high] }
                                    evidence:
                                      type: array
                                      items: { type: string }
                                    note: { type: string }
                              active:
                                type: array
                                items:
                                  type: object
                                  properties:
                                    topic: { type: string }
                                    confidence: { type: string, enum: [low, medium, high] }
                                    note: { type: string }
                              notes:
                                type: array
                                items: { type: string }
                      cached: { type: boolean }
                      timestamp: { type: string, format: date-time }
                  timestamp:
                    type: string
                    format: date-time

  /ai/analysis/macro-risk:
    post:
      tags: [Analyse IA]
      summary: Alias of /ai/market-risk-overlay
      description: Same behavior as POST /ai/market-risk-overlay.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ticker:
                  type: string
                options_analysis:
                  type: object
                lookahead_days:
                  type: number
              required: [ticker, options_analysis, lookahead_days]
      responses:
        '200':
          description: Macro risk overlay
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticker:
                    type: string
                  analysis:
                    type: object
                  timestamp:
                    type: string
                    format: date-time

  /ingest/macro-calendar:
    post:
      tags: [Ingestion]
      summary: Ingest (cache) macro economic calendar for US/CN/JP only
      description: >
        Fetches the combined economic calendar and stores a filtered subset (US/CN/JP only)
        in cache for consumption by /ai/market-risk-overlay. No LLM call.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                lookahead_days:
                  type: number
                  description: "Horizon in days (default 7, max 30)"
      responses:
        '200':
          description: Cached macro calendar
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  scope: { type: string, example: "US/CN/JP" }
                  from: { type: string }
                  to: { type: string }
                  count: { type: number }
                  events:
                    type: array
                    items:
                      type: object
                      properties:
                        date: { type: string }
                        event: { type: string }
                        country: { type: string, nullable: true }
                        currency: { type: string, nullable: true }
                        impact: { type: string, nullable: true }
                        time: { type: string, nullable: true }
                        source: { type: string, nullable: true }
                  cached: { type: boolean }
                  timestamp: { type: string, format: date-time }

  /ai/ticker-news-events-analysis:
    post:
      tags: [Analyse IA]
      summary: Analyser les news et événements d'un ticker
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
      responses:
        '200':
          description: Analyse des news et événements
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/financial-juice/analyze:
    post:
      tags: [Analyse IA]
      summary: Analyser un headline Financial Juice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - headline
              properties:
                headline:
                  type: string
      responses:
        '200':
          description: Analyse du headline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/financial-juice/latest:
    get:
      tags: [Analyse IA]
      summary: Récupérer la dernière analyse Financial Juice
      responses:
        '200':
          description: Dernière analyse
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/economic-calendar-analysis:
    post:
      tags: [Analyse IA]
      summary: Analyser le calendrier économique
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                from:
                  type: string
                  format: date
                to:
                  type: string
                  format: date
      responses:
        '200':
          description: Analyse du calendrier économique
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysisResponse'

  /ai/cache/invalidate/{ticker}:
    post:
      tags: [Analyse IA]
      summary: Invalider le cache d'analyse pour un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cache invalidé
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  # ============================================
  # ANALYSE COMBINÉE
  # ============================================
  /analysis/{ticker}/complete:
    get:
      tags: [Analyse Combinée]
      summary: Analyse complète d'un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Analyse complète
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombinedAnalysisResponse'

  /analysis/{ticker}/divergence:
    get:
      tags: [Analyse Combinée]
      summary: Détection de divergences
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Divergences détectées
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DivergenceAnalysisResponse'

  /analysis/{ticker}/valuation:
    get:
      tags: [Analyse Combinée]
      summary: Valuation complète
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Valuation complète
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValuationResponse'

  /analysis/{ticker}/earnings-prediction:
    get:
      tags: [Analyse Combinée]
      summary: Prédiction d'Earnings
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: earningsDate
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Prédiction d'earnings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EarningsPredictionResponse'

  /screener/multi-criteria:
    post:
      tags: [Analyse Combinée]
      summary: Screening multi-critères
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                criteria:
                  type: object
      responses:
        '200':
          description: Résultats du screening
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object

  /analysis/{ticker}/risk:
    get:
      tags: [Analyse Combinée]
      summary: Analyse de risque
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Analyse de risque
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskAnalysisResponse'

  /institutions/{name}/tracking:
    get:
      tags: [Analyse Combinée]
      summary: Suivi d'une institution
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Données de suivi
          content:
            application/json:
              schema:
                type: object

  /analysis/sector/{sector}:
    get:
      tags: [Analyse Combinée]
      summary: Analyse sectorielle
      parameters:
        - name: sector
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Analyse sectorielle
          content:
            application/json:
              schema:
                type: object

  /market-analysis/sector-rotation:
    get:
      tags: [Analyse Combinée]
      summary: Analyse de rotation sectorielle
      responses:
        '200':
          description: Rotation sectorielle
          content:
            application/json:
              schema:
                type: object

  /market-analysis/market-tide:
    get:
      tags: [Analyse Combinée]
      summary: Analyse du marché (tide)
      responses:
        '200':
          description: Analyse du marché
          content:
            application/json:
              schema:
                type: object

  # ============================================
  # SCORING
  # ============================================
  /ticker-analysis/{ticker}/score:
    get:
      tags: [Scoring]
      summary: Calculer le score composite d'un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Score composite
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticker:
                    type: string
                  score:
                    type: number
                  breakdown:
                    type: object

  /ticker-analysis/{ticker}/breakdown:
    get:
      tags: [Scoring]
      summary: Breakdown détaillé du score
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Breakdown détaillé
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticker:
                    type: string
                  score:
                    type: number
                  breakdown:
                    type: object

  /ticker-analysis/{ticker}/gamma-squeeze:
    get:
      tags: [Scoring]
      summary: Analyser le potentiel de gamma squeeze
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Analyse gamma squeeze
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticker:
                    type: string
                  gamma_squeeze_score:
                    type: number
                  analysis:
                    type: object

  # ============================================
  # SURVEILLANCE
  # ============================================
  /surveillance/watch:
    post:
      tags: [Surveillance]
      summary: Créer une surveillance pour un ticker
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
              properties:
                ticker:
                  type: string
                minPremium:
                  type: number
                callVolumeThreshold:
                  type: number
                putVolumeThreshold:
                  type: number
                darkPoolVolumeThreshold:
                  type: number
                shortInterestThreshold:
                  type: number
                insiderChangeThreshold:
                  type: number
                checkInterval:
                  type: string
                notificationChannels:
                  type: array
                  items:
                    type: string
                active:
                  type: boolean
      responses:
        '200':
          description: Surveillance créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  ticker:
                    type: string
                  active:
                    type: boolean

  /surveillance/watches:
    get:
      tags: [Surveillance]
      summary: Récupérer toutes les surveillances de l'utilisateur
      responses:
        '200':
          description: Liste des surveillances
          content:
            application/json:
              schema:
                type: object
                properties:
                  watches:
                    type: array
                    items:
                      type: object

  /surveillance/watch/{id}:
    delete:
      tags: [Surveillance]
      summary: Supprimer une surveillance
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Surveillance supprimée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /surveillance/watch/{id}/alerts:
    get:
      tags: [Surveillance]
      summary: Récupérer les alertes d'une surveillance
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Liste des alertes
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    type: array
                    items:
                      type: object

  /surveillance/watch/{id}/check:
    post:
      tags: [Surveillance]
      summary: Déclencher manuellement la vérification d'une surveillance
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Vérification effectuée
          content:
            application/json:
              schema:
                type: object

  # ============================================
  # ALERTS
  # ============================================
  /alerts:
    post:
      tags: [Alerts]
      summary: Créer une alerte personnalisée
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
                - name
              properties:
                ticker:
                  type: string
                name:
                  type: string
                description:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                logic:
                  type: string
                  enum: [AND, OR]
                  default: AND
                notificationChannels:
                  type: array
                  items:
                    type: string
                active:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Alerte créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  ticker:
                    type: string
                  name:
                    type: string
                  active:
                    type: boolean

    get:
      tags: [Alerts]
      summary: Récupérer toutes les alertes de l'utilisateur
      responses:
        '200':
          description: Liste des alertes
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    type: array
                    items:
                      type: object

  /alerts/{id}:
    get:
      tags: [Alerts]
      summary: Récupérer une alerte par ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Détails de l'alerte
          content:
            application/json:
              schema:
                type: object

    put:
      tags: [Alerts]
      summary: Mettre à jour une alerte
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                active:
                  type: boolean
      responses:
        '200':
          description: Alerte mise à jour
          content:
            application/json:
              schema:
                type: object

    delete:
      tags: [Alerts]
      summary: Supprimer une alerte
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Alerte supprimée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /alerts/{id}/test:
    post:
      tags: [Alerts]
      summary: Tester une alerte
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Résultat du test
          content:
            application/json:
              schema:
                type: object
                properties:
                  triggered:
                    type: boolean
                  message:
                    type: string

  # ============================================
  # ATTRIBUTION
  # ============================================
  /attribution/flow:
    post:
      tags: [Attribution]
      summary: Attribuer un flow options à des entités
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticker
                - flowType
                - premium
                - timestamp
              properties:
                ticker:
                  type: string
                flowType:
                  type: string
                premium:
                  type: number
                timestamp:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Flow attribué
          content:
            application/json:
              schema:
                type: object

  /attribution/institution/{institutionId}/ticker/{ticker}:
    get:
      tags: [Attribution]
      summary: Attribuer l'influence d'une institution sur un ticker
      parameters:
        - name: institutionId
          in: path
          required: true
          schema:
            type: string
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: period
          in: query
          required: false
          schema:
            type: string
            default: 3M
      responses:
        '200':
          description: Influence de l'institution
          content:
            application/json:
              schema:
                type: object

  /attribution/dominant-entities/{ticker}:
    get:
      tags: [Attribution]
      summary: Trouver les entités dominantes pour un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Entités dominantes
          content:
            application/json:
              schema:
                type: object

  /attribution/clusters:
    get:
      tags: [Attribution]
      summary: Clustering institutionnel
      parameters:
        - name: sector
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Clusters d'institutions
          content:
            application/json:
              schema:
                type: object

  /graph/test-connection:
    get:
      tags: [Attribution]
      summary: Tester la connexion Neo4j
      responses:
        '200':
          description: Statut de la connexion
          content:
            application/json:
              schema:
                type: object
                properties:
                  connected:
                    type: boolean

  # ============================================
  # SMART MONEY
  # ============================================
  /smart-money/top-hedge-funds:
    get:
      tags: [Smart Money]
      summary: Récupérer les top hedge funds
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Liste des top hedge funds
          content:
            application/json:
              schema:
                type: object
                properties:
                  funds:
                    type: array
                    items:
                      type: object

  /smart-money/institution/{name}/copy-trades/{ticker}:
    get:
      tags: [Smart Money]
      summary: Récupérer les copy trades d'une institution pour un ticker
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Copy trades
          content:
            application/json:
              schema:
                type: object

  # ============================================
  # FMP (Financial Modeling Prep)
  # ============================================
  /fmp/quote/{symbol}:
    get:
      tags: [FMP]
      summary: Récupérer le quote d'un symbole
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: force_refresh
          in: query
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Quote du symbole
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object

  /fmp/income-statement/{symbol}:
    get:
      tags: [FMP]
      summary: Récupérer l'income statement
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 5
        - name: period
          in: query
          required: false
          schema:
            type: string
            enum: [Q1, Q2, Q3, Q4, FY, annual, quarter]
      responses:
        '200':
          description: Income statement
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object

  /fmp/balance-sheet-statement/{symbol}:
    get:
      tags: [FMP]
      summary: Récupérer le balance sheet
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 5
        - name: period
          in: query
          required: false
          schema:
            type: string
            enum: [Q1, Q2, Q3, Q4, FY, annual, quarter]
      responses:
        '200':
          description: Balance sheet
          content:
            application/json:
              schema:
                type: object

  /fmp/cash-flow-statement/{symbol}:
    get:
      tags: [FMP]
      summary: Récupérer le cash flow statement
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 5
        - name: period
          in: query
          required: false
          schema:
            type: string
            enum: [Q1, Q2, Q3, Q4, FY, annual, quarter]
      responses:
        '200':
          description: Cash flow statement
          content:
            application/json:
              schema:
                type: object

  /fmp/key-metrics/{symbol}:
    get:
      tags: [FMP]
      summary: Récupérer les key metrics
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 5
      responses:
        '200':
          description: Key metrics
          content:
            application/json:
              schema:
                type: object

  /fmp/financial-ratios/{symbol}:
    get:
      tags: [FMP]
      summary: Récupérer les financial ratios
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 5
      responses:
        '200':
          description: Financial ratios
          content:
            application/json:
              schema:
                type: object

  /fmp/search-symbol:
    get:
      tags: [FMP]
      summary: Rechercher un symbole
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Résultats de recherche
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object

  /fmp/technical-indicators/sma/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - SMA
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
            example: 2025-09-09
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
            example: 2025-12-09
      responses:
        '200':
          description: SMA values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        sma:
                          type: number

  /fmp/technical-indicators/ema/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - EMA
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: EMA values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        ema:
                          type: number

  /fmp/technical-indicators/wma/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - WMA
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: WMA values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        wma:
                          type: number

  /fmp/technical-indicators/dema/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - DEMA
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: DEMA values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        dema:
                          type: number

  /fmp/technical-indicators/tema/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - TEMA
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: TEMA values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        tema:
                          type: number

  /fmp/technical-indicators/rsi/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - RSI
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: RSI values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        rsi:
                          type: number

  /fmp/technical-indicators/standard-deviation/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - Standard Deviation
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Standard deviation values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        standardDeviation:
                          type: number

  /fmp/technical-indicators/williams/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - Williams
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Williams values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        williams:
                          type: number

  /fmp/technical-indicators/adx/{symbol}:
    get:
      tags: [FMP]
      summary: Technical Indicator - ADX
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: periodLength
          in: query
          required: true
          schema:
            type: integer
            example: 10
        - name: timeframe
          in: query
          required: true
          schema:
            type: string
            enum: [1min, 5min, 15min, 30min, 1hour, 4hour, 1day]
            example: 1day
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: ADX values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        open:
                          type: number
                        high:
                          type: number
                        low:
                          type: number
                        close:
                          type: number
                        volume:
                          type: number
                        adx:
                          type: number

  # ============================================
  # UNUSUAL WHALES
  # ============================================
  /unusual-whales/institution-ownership/{ticker}:
    get:
      tags: [Unusual Whales]
      summary: Récupérer l'ownership institutionnel
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: force_refresh
          in: query
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Ownership institutionnel
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object

  /unusual-whales/institution-activity/{ticker}:
    get:
      tags: [Unusual Whales]
      summary: Récupérer l'activité institutionnelle
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: institution_name
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Activité institutionnelle
          content:
            application/json:
              schema:
                type: object

  /unusual-whales/option-trades/flow-alerts:
    get:
      tags: [Unusual Whales]
      summary: Récupérer les flow alerts (option-trades/flow-alerts)
      description: |
        Proxy vers l'API Unusual Whales `/option-trades/flow-alerts`.
        Détecte les gros blocs de trades options (sweeps, floor trades, etc.).
        
        **Données brutes** : Retourne les données telles quelles depuis l'API Unusual Whales.
        Pour une analyse enrichie, utiliser `POST /ingest/options-flow-alerts` puis `POST /ai/options-unusual-activity`.
      parameters:
        - name: ticker_symbol
          in: query
          required: false
          schema:
            type: string
            example: FISV
          description: "Liste de tickers séparés par des virgules (ex: AAPL,INTC). Pour exclure, préfixer avec -"
        - name: min_premium
          in: query
          required: false
          schema:
            type: number
            format: float
            minimum: 0
            example: 1000000
          description: "Prime minimum en USD (défaut: 0)"
        - name: max_premium
          in: query
          required: false
          schema:
            type: number
            format: float
            minimum: 0
          description: "Prime maximum en USD"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 100
          description: "Nombre d'éléments à retourner (1-200, défaut: 100)"
        - name: is_call
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: "Inclure les calls (défaut: true)"
        - name: is_put
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: "Inclure les puts (défaut: true)"
        - name: is_sweep
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: "Inclure les sweeps (défaut: true)"
        - name: is_floor
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: "Inclure les floor trades (défaut: true)"
        - name: is_otm
          in: query
          required: false
          schema:
            type: boolean
          description: Inclure uniquement les contrats out-of-the-money
        - name: min_dte
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Jours jusqu'à expiration minimum
        - name: max_dte
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Jours jusqu'à expiration maximum
        - name: newer_than
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Date/heure minimum (ISO 8601 ou Unix timestamp)
        - name: older_than
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Date/heure maximum (ISO 8601 ou Unix timestamp)
      responses:
        '200':
          description: Flow alerts récupérées avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        alert_rule:
                          type: string
                          example: RepeatedHits
                          description: Nom de la règle d'alerte
                        all_opening_trades:
                          type: boolean
                          example: false
                          description: Toutes les transactions sont des transactions d'ouverture
                        created_at:
                          type: string
                          format: date-time
                          example: "2025-01-15T14:30:00Z"
                          description: Timestamp UTC
                        expiry:
                          type: string
                          format: date
                          example: "2025-01-17"
                          description: Date d'expiration du contrat
                        expiry_count:
                          type: integer
                          example: 1
                          description: Nombre d'expirations (1 si single-leg, >1 si multi-leg)
                        has_floor:
                          type: boolean
                          example: false
                          description: Si le trade est un floor trade
                        has_multileg:
                          type: boolean
                          example: false
                          description: Si le trade est multi-leg
                        has_singleleg:
                          type: boolean
                          example: true
                          description: Si le trade est single-leg
                        has_sweep:
                          type: boolean
                          example: true
                          description: Si le trade est un sweep
                        issue_type:
                          type: string
                          example: Common Stock
                          description: Type d'émission du ticker
                        open_interest:
                          type: integer
                          example: 125000
                          description: Intérêt ouvert
                        option_chain:
                          type: string
                          example: FISV250117P00065000
                          description: Symbole d'option du contrat
                        price:
                          type: number
                          format: float
                          example: 0.18
                          description: Prix
                        strike:
                          type: string
                          example: "65"
                          description: Strike du contrat
                        ticker:
                          type: string
                          example: FISV
                          description: Ticker
                        total_ask_side_prem:
                          type: number
                          format: float
                          example: 16000000
                          description: Prime totale côté ask (pour déterminer buy)
                        total_bid_side_prem:
                          type: number
                          format: float
                          example: 0
                          description: Prime totale côté bid (pour déterminer sell)
                        total_premium:
                          type: number
                          format: float
                          example: 16000000
                          description: Prime totale
                        total_size:
                          type: integer
                          example: 88000
                          description: Taille totale (nombre de contrats)
                        trade_count:
                          type: integer
                          example: 1
                          description: Nombre de transactions
                        type:
                          type: string
                          enum: [call, put]
                          example: put
                          description: Type de contrat
                        underlying_price:
                          type: number
                          format: float
                          example: 67.50
                          description: Prix sous-jacent
                        volume:
                          type: integer
                          example: 88000
                          description: Volume
                        volume_oi_ratio:
                          type: number
                          format: float
                          example: 0.704
                          description: Ratio volume/OI
                  cached:
                    type: boolean
                    example: false
                  count:
                    type: integer
                    example: 1
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-15T15:00:00Z"
        '400':
          description: Paramètre invalide
        '500':
          description: Erreur serveur

  /unusual-whales/option-trades/full-tape/{date}:
    get:
      tags: [Unusual Whales]
      summary: Télécharger le Full Tape pour une date de trading
      description: |
        Proxy vers l'API Unusual Whales `/option-trades/full-tape/{date}`.
        Télécharge toutes les transactions d'options (le "full tape") pour une date de trading donnée.
        
        **⚠️ IMPORTANT** :
        - Cet endpoint nécessite un abonnement **Advanced API** chez Unusual Whales
        - Les 3 derniers jours de trading sont disponibles
        - Retourne un fichier ZIP (pas du JSON)
        - L'endpoint retourne une URL signée avec l'API key pour télécharger le ZIP
        
        **Utilisation** :
        - Pour analyser toutes les transactions d'un jour spécifique
        - Fallback si les flow alerts ne retournent pas un trade spécifique
        - Analyse complète du marché pour une date donnée
      parameters:
        - name: date
          in: path
          required: true
          description: "Date de trading au format YYYY-MM-DD (ex: 2025-01-15)"
          schema:
            type: string
            format: date
          example: "2025-01-15"
      responses:
        '200':
          description: URL pour télécharger le fichier ZIP du full tape
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      endpoint:
                        type: string
                        example: "/option-trades/full-tape/2025-01-15"
                        description: Endpoint Unusual Whales
                      url:
                        type: string
                        example: "https://api.unusualwhales.com/api/option-trades/full-tape/2025-01-15?Authorization=Bearer YOUR_API_KEY"
                        description: URL complète avec API key pour télécharger le ZIP
                  cached:
                    type: boolean
                    example: false
                  count:
                    type: integer
                    example: 1
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-15T15:00:00Z"
        '400':
          description: Date invalide ou format incorrect
        '404':
          description: Date non disponible (seulement les 3 derniers jours de trading)
        '500':
          description: Erreur serveur

  /unusual-whales/option-contract/{id}/volume-profile:
    get:
      tags: [Unusual Whales]
      summary: Récupérer le Volume Profile d'un contrat d'option
      description: |
        Proxy vers l'API Unusual Whales `/option-contract/{id}/volume-profile`.
        Retourne le profil de volume (volume - sweep, floor, cross, ask, bid, etc. - par prix de remplissage) 
        pour un symbole d'option sur une date de trading donnée.
        
        **Utilisation** :
        - Comparer le volume d'un contrat spécifique avec sa moyenne historique
        - Détecter si un trade est vraiment inhabituel pour ce strike/expiry précis
        - Analyser la répartition du volume par type de trade (sweep, floor, ask, bid, etc.)
        - Fallback si les flow alerts ne retournent pas assez de détails sur un contrat
        
        **Note** : Si aucune date n'est fournie, retourne les données pour le dernier jour de marché.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[A-Z0-9]+$'
            example: "FISV250117P00065000"
          description: |
            Symbole d'option au format ISO (ex: FISV250117P00065000).
            Format: TICKER + YYMMDD + C/P + STRIKE (avec zéros à gauche)
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
            example: "2025-01-15"
          description: |
            Date de trading au format YYYY-MM-DD.
            Si omise, utilise le dernier jour de marché.
      responses:
        '200':
          description: Volume profile récupéré avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        ask_vol:
                          type: integer
                          example: 119403
                          description: Volume côté ask
                        bid_vol:
                          type: integer
                          example: 122789
                          description: Volume côté bid
                        cross_vol:
                          type: integer
                          example: 0
                          description: Volume cross (transactions avec code cross trade)
                        date:
                          type: string
                          format: date
                          example: "2025-01-15"
                          description: Date de trading au format ISO
                        floor_vol:
                          type: integer
                          example: 142
                          description: Volume floor (transactions avec code floor trade)
                        mid_vol:
                          type: integer
                          example: 22707
                          description: Volume au milieu de l'ask et du bid
                        multi_vol:
                          type: integer
                          example: 7486
                          description: Volume multi-leg (spreads, rolls, condors, butterflies, etc.)
                        price:
                          type: string
                          example: "21.50"
                          description: Prix de remplissage du trade d'option
                        sweep_vol:
                          type: integer
                          example: 18260
                          description: Volume sweep (transactions avec code sweep trade)
                        transactions:
                          type: integer
                          example: 39690
                          description: Nombre de transactions pour ce contrat à ce prix
                        volume:
                          type: integer
                          example: 264899
                          description: Volume total du contrat à ce prix
                  cached:
                    type: boolean
                    example: false
                  count:
                    type: integer
                    example: 2
                    description: Nombre d'entrées dans le volume profile
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-15T15:00:00Z"
        '400':
          description: ID de contrat invalide ou format incorrect
        '404':
          description: Contrat non trouvé
        '422':
          description: Paramètres invalides
        '500':
          description: Erreur serveur

  /unusual-whales/stock/{ticker}/option-contracts:
    get:
      tags: [Unusual Whales]
      summary: Liste tous les contrats d'options pour un ticker
      description: |
        Proxy vers l'API Unusual Whales `/stock/{ticker}/option-contracts`.
        Retourne tous les contrats d'options disponibles pour un ticker donné.
        
        **Utilisation** :
        - Pour lister tous les contrats d'un ticker (calls et puts, tous strikes, toutes expiries)
        - Pour trouver un contrat spécifique par strike/type/expiry
        - Pour obtenir l'`option_symbol` nécessaire pour d'autres endpoints (ex: `/option-contract/{id}/volume-profile`)
        - **ESSENTIEL** pour l'ingestion via `/ingest/option-contracts-daily`
        
        **Filtres disponibles** :
        - `option_type` : call ou put
        - `expiry` : date d'expiration (YYYY-MM-DD)
        - `limit` : nombre de résultats (1-500, défaut: 100)
        - `page` : pagination (0-indexed)
        - `exclude_zero_dte` : exclure les contrats à 0 jours jusqu'à expiration
        - `exclude_zero_oi_chains` : exclure les contrats avec OI = 0
        - `exclude_zero_vol_chains` : exclure les contrats avec volume = 0
        - `vol_greater_oi` : seulement les contrats où volume > OI
        - `maybe_otm_only` : seulement les contrats potentiellement out-of-the-money
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
            example: FISV
          description: Symbole du ticker
        - name: option_type
          in: query
          required: false
          schema:
            type: string
            enum: [call, put]
            example: put
          description: Filtrer par type d'option (call ou put)
        - name: expiry
          in: query
          required: false
          schema:
            type: string
            format: date
            example: "2026-01-16"
          description: Filtrer par date d'expiration (YYYY-MM-DD)
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
          description: "Nombre de résultats à retourner (max: 500)"
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Numéro de page (0-indexed, pour pagination)
        - name: exclude_zero_dte
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Exclure les contrats à 0 jours jusqu'à expiration
        - name: exclude_zero_oi_chains
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Exclure les contrats avec Open Interest = 0
        - name: exclude_zero_vol_chains
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Exclure les contrats avec volume = 0
        - name: vol_greater_oi
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Seulement les contrats où volume > Open Interest
        - name: maybe_otm_only
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Seulement les contrats potentiellement out-of-the-money
      responses:
        '200':
          description: Liste des contrats d'options récupérée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        option_symbol:
                          type: string
                          example: "FISV260220P00065000"
                          description: Symbole d'option au format ISO
                        ticker:
                          type: string
                          example: "FISV"
                        type:
                          type: string
                          enum: [call, put]
                          example: "put"
                        strike:
                          type: number
                          example: 65.0
                        expiry:
                          type: string
                          format: date
                          example: "2026-02-20"
                        volume:
                          type: integer
                          example: 88000
                          description: Volume du jour
                        open_interest:
                          type: integer
                          example: 125000
                          description: Open Interest actuel
                        ask_volume:
                          type: integer
                          example: 45000
                          description: Volume côté ask
                        bid_volume:
                          type: integer
                          example: 43000
                          description: Volume côté bid
                        mid_volume:
                          type: integer
                          example: 0
                          description: Volume au milieu
                        multi_leg_volume:
                          type: integer
                          example: 5000
                          description: Volume multi-leg
                        total_premium:
                          type: number
                          example: 16000000
                          description: Premium total en USD
                        last_price:
                          type: number
                          example: 1.82
                          description: Dernier prix
                        underlying_price:
                          type: number
                          example: 68.50
                          description: Prix du sous-jacent
                        iv:
                          type: number
                          nullable: true
                          example: 0.25
                          description: Implied Volatility
                        delta:
                          type: number
                          nullable: true
                          example: -0.45
                          description: Delta grec
                        gamma:
                          type: number
                          nullable: true
                          example: 0.02
                          description: Gamma grec
                        theta:
                          type: number
                          nullable: true
                          example: -0.05
                          description: Theta grec
                        vega:
                          type: number
                          nullable: true
                          example: 0.15
                          description: Vega grec
                  cached:
                    type: boolean
                    example: false
                  count:
                    type: integer
                    example: 150
                    description: Nombre total de contrats retournés
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-12-18T15:00:00Z"
        '400':
          description: Paramètres invalides
        '404':
          description: Ticker non trouvé
        '500':
          description: Erreur serveur

  /unusual-whales/stock/{ticker}/oi-change:
    get:
      tags: [Unusual Whales]
      summary: OI Change pour un ticker (proxy de `GET https://api.unusualwhales.com/api/stock/{ticker}/oi-change`)
      description: |
        Retourne les contrats d'options d'un ticker avec leur changement d'Open Interest (OI) par rapport à la veille.
        Les données sont ordonnées par OI change absolu (par défaut décroissant).
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: AAPL, NVDA)"
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: |
            Date de trading au format YYYY-MM-DD.
            Si omise, utilise le dernier jour de marché.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: Nombre maximum de contrats à retourner. Si omis, retourne tous les résultats.
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [desc, asc]
            default: desc
          description: Ordre de tri par OI change absolu (desc par défaut).
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Numéro de page (utilisé avec limit). Commence à 0.
      responses:
        '200':
          description: Liste des contrats d'options avec leur OI change
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        avg_price:
                          type: number
                          nullable: true
                        curr_date:
                          type: string
                          format: date
                        curr_oi:
                          type: integer
                        last_ask:
                          type: number
                          nullable: true
                        last_bid:
                          type: number
                          nullable: true
                        last_date:
                          type: string
                          format: date
                        last_fill:
                          type: number
                          nullable: true
                        last_oi:
                          type: integer
                        oi_change:
                          type: number
                          description: OI change relatif (ratio) par rapport à la veille
                        oi_diff_plain:
                          type: integer
                          description: Différence brute d'OI (curr_oi - last_oi)
                        option_symbol:
                          type: string
                          description: Symbole de l'option
                        percentage_of_total:
                          type: number
                          nullable: true
                        prev_ask_volume:
                          type: integer
                          nullable: true
                        prev_bid_volume:
                          type: integer
                          nullable: true
                        prev_mid_volume:
                          type: integer
                          nullable: true
                        prev_multi_leg_volume:
                          type: integer
                          nullable: true
                        prev_neutral_volume:
                          type: integer
                          nullable: true
                        prev_stock_multi_leg_volume:
                          type: integer
                          nullable: true
                        prev_total_premium:
                          type: number
                          nullable: true
                        rnk:
                          type: integer
                          nullable: true
                        trades:
                          type: integer
                          nullable: true
                        underlying_symbol:
                          type: string
                        volume:
                          type: integer
                  cached:
                    type: boolean
                  count:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  /unusual-whales/stock/{ticker}/oi-per-strike:
    get:
      tags: [Unusual Whales]
      summary: OI par strike pour un ticker (proxy de `GET https://api.unusualwhales.com/api/stock/{ticker}/oi-per-strike`)
      description: |
        Retourne, pour chaque strike, l'Open Interest total des calls et des puts pour un ticker donné.
        Si aucune date n'est fournie, utilise le dernier jour de marché.
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: AAPL, NVDA)"
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Date de trading au format YYYY-MM-DD. Optionnelle, par défaut dernier jour de marché.
      responses:
        '200':
          description: Liste des strikes avec leur OI calls/puts
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        call_oi:
                          type: integer
                          description: Open Interest total des calls pour ce strike
                        put_oi:
                          type: integer
                          description: Open Interest total des puts pour ce strike
                        date:
                          type: string
                          format: date
                          description: Date de la donnée (ISO)
                        strike:
                          type: string
                          description: "Strike du contrat (ex: 375)"
                  cached:
                    type: boolean
                  count:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  /unusual-whales/stock/{ticker}/iv-rank:
    get:
      tags: [Unusual Whales]
      summary: IV Rank pour un ticker (proxy de `GET https://api.unusualwhales.com/api/stock/{ticker}/iv-rank`)
      description: |
        Retourne les données d'IV Rank pour un ticker sur une période donnée.
        L'IV Rank mesure où se situe la volatilité implicite actuelle par rapport à sa plage historique.
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: AAPL, NVDA)"
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: |
            Date de trading au format YYYY-MM-DD.
            Optionnelle, par défaut le dernier jour de marché.
        - name: timespan
          in: query
          required: false
          schema:
            type: string
          description: |
            Période sur laquelle calculer l'IV Rank.
            Accepte des valeurs comme '1y', '6m', '3m', '1m', '1w' ou une date ISO (ex: 2024-01-25).
      responses:
        '200':
          description: Données d'IV Rank pour le ticker
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        close:
                          type: string
                          description: Prix de clôture du sous-jacent
                          example: "182.91"
                        date:
                          type: string
                          format: date
                          description: Date de trading (ISO)
                          example: "2023-09-08"
                        iv_rank_1y:
                          type: string
                          description: Valeur d'IV Rank (0–1) sur 1 an
                          example: "0.65"
                        updated_at:
                          type: string
                          format: date-time
                          description: Timestamp de mise à jour en UTC
                          example: "2023-12-12T16:35:52.168490Z"
                        volatility:
                          type: string
                          description: Volatilité implicite courante
                          example: "0.25"
                  cached:
                    type: boolean
                  count:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  /unusual-whales/stock/{ticker}/max-pain:
    get:
      tags: [Unusual Whales]
      summary: Max Pain pour un ticker (proxy de `GET https://api.unusualwhales.com/api/stock/{ticker}/max-pain`)
      description: |
        Retourne le max pain pour toutes les expirations d'un ticker sur les 120 derniers jours.
        Le max pain est le prix auquel le plus grand nombre de positions options (calls + puts) expirent sans valeur.
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: AAPL, NVDA)"
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: |
            Date de trading au format YYYY-MM-DD.
            Optionnelle, par défaut le dernier jour de marché.
      responses:
        '200':
          description: Max pain par date d'expiration pour le ticker
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        expiry:
                          type: string
                          format: date
                          description: Date d'expiration du contrat
                          example: "2024-03-04"
                        max_pain:
                          type: string
                          description: Niveau de prix de max pain pour cette expiration
                          example: "473"
                  date:
                    type: string
                    format: date
                    description: Date de référence de la donnée retournée
                  cached:
                    type: boolean
                  count:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  /unusual-whales/stock/{ticker}/greek-exposure/strike:
    get:
      tags: [Unusual Whales]
      summary: Greek exposure par strike (RAW UW) — pour comparer avec l’agrégation
      description: |
        Proxy de `GET https://api.unusualwhales.com/api/stock/{ticker}/greek-exposure/strike`.
        Utile pour comparer le résultat brut UW avec notre bloc agrégé (ingestion `/ingest/greeks`).
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
          description: "Symbole du ticker (ex: NVDA)"
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: "Date de trading (YYYY-MM-DD), optionnelle."
      responses:
        '200':
          description: Données brutes UW (exposition grecque par strike)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                        strike:
                          type: string
                        call_delta:
                          type: string
                        put_delta:
                          type: string
                        call_gex:
                          type: string
                          description: Gamma exposure (UW field)
                        put_gex:
                          type: string
                          description: Gamma exposure (UW field)
                        call_charm:
                          type: string
                        put_charm:
                          type: string
                        call_vanna:
                          type: string
                        put_vanna:
                          type: string
                  cached:
                    type: boolean
                  count:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  /unusual-whales/stock/{ticker}/greek-exposure/strike-expiry:
    get:
      tags: [Unusual Whales]
      summary: Greek exposure par strike + expiry (RAW UW)
      description: |
        Proxy de `GET https://api.unusualwhales.com/api/stock/{ticker}/greek-exposure/strike-expiry`.
        Requiert une expiration (`expiry`) pour isoler une échéance précise.
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: expiry
          in: query
          required: true
          schema:
            type: string
            format: date
          description: "Expiration unique (YYYY-MM-DD), requise."
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Données brutes UW (exposition grecque par strike et expiration)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                        expiry:
                          type: string
                          format: date
                        strike:
                          type: string
                        call_delta:
                          type: string
                        put_delta:
                          type: string
                        call_gex:
                          type: string
                          description: Gamma exposure (UW field)
                        put_gex:
                          type: string
                          description: Gamma exposure (UW field)
                  cached:
                    type: boolean
                  count:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  /unusual-whales/stock/{ticker}/flow-recent:
    get:
      tags: [Unusual Whales]
      summary: Récupérer les flows récents d'un ticker
      description: |
        Récupère les flows d'options récents depuis le cache Supabase.
        Si les données ne sont pas en cache, appelle l'API UW et stocke.
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
            example: NVDA
        - name: min_premium
          in: query
          required: false
          schema:
            type: number
          description: Premium minimum pour filtrer les trades
        - name: side
          in: query
          required: false
          schema:
            type: string
            enum: [call, put]
          description: Filtrer par type d'option
      responses:
        '200':
          description: Flows récents
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        ticker:
                          type: string
                        expiry:
                          type: string
                        strike:
                          type: number
                        option_type:
                          type: string
                          enum: [call, put]
                        volume:
                          type: number
                        premium:
                          type: number
                        executed_at:
                          type: string
                          format: date-time
                  cached:
                    type: boolean
                  count:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  # ============================================
  # TICKER ACTIVITY
  # ============================================
  /ticker-activity/{ticker}/quote:
    get:
      tags: [Ticker Activity]
      summary: Récupérer le quote d'un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Quote du ticker
          content:
            application/json:
              schema:
                type: object

  /ticker-activity/{ticker}/activity:
    get:
      tags: [Ticker Activity]
      summary: Récupérer l'activité complète d'un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
        - name: force_refresh
          in: query
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Activité complète
          content:
            application/json:
              schema:
                type: object

  /ticker-activity/{ticker}/options:
    get:
      tags: [Ticker Activity]
      summary: Récupérer les options d'un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
        - name: min_premium
          in: query
          required: false
          schema:
            type: integer
            default: 10000
      responses:
        '200':
          description: Options du ticker
          content:
            application/json:
              schema:
                type: object

  /ticker-activity/{ticker}/dark-pool:
    get:
      tags: [Ticker Activity]
      summary: Récupérer les dark pool trades d'un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Dark pool trades
          content:
            application/json:
              schema:
                type: object

  /ticker-insights/{ticker}:
    get:
      tags: [Ticker Activity]
      summary: Récupérer les insights complets d'un ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Insights complets
          content:
            application/json:
              schema:
                type: object

  # ============================================
  # SIGNALS
  # ============================================
  /signals:
    get:
      tags: [Signals]
      summary: Récupérer les signaux
      parameters:
        - name: source
          in: query
          required: false
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
        - name: min_importance
          in: query
          required: false
          schema:
            type: integer
      responses:
        '200':
          description: Liste des signaux
          content:
            application/json:
              schema:
                type: object
                properties:
                  signals:
                    type: array
                    items:
                      type: object

    post:
      tags: [Signals]
      summary: Créer un signal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Signal créé
          content:
            application/json:
              schema:
                type: object

  /signals/{id}:
    get:
      tags: [Signals]
      summary: Récupérer un signal par ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Détails du signal
          content:
            application/json:
              schema:
                type: object

  /search:
    post:
      tags: [Signals]
      summary: Rechercher des signaux
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                limit:
                  type: integer
                  default: 20
      responses:
        '200':
          description: Résultats de recherche
          content:
            application/json:
              schema:
                type: object

  /chat:
    post:
      tags: [Signals]
      summary: Chat avec les données
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                message:
                  type: string
      responses:
        '200':
          description: Réponse du chat
          content:
            application/json:
              schema:
                type: object

  # ============================================
  # FUNDS
  # ============================================
  /funds:
    get:
      tags: [Funds]
      summary: Récupérer tous les fonds
      responses:
        '200':
          description: Liste des fonds
          content:
            application/json:
              schema:
                type: object
                properties:
                  funds:
                    type: array
                    items:
                      type: object

    post:
      tags: [Funds]
      summary: Créer un fond
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Fond créé
          content:
            application/json:
              schema:
                type: object

  /funds/{id}:
    get:
      tags: [Funds]
      summary: Récupérer un fond par ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détails du fond
          content:
            application/json:
              schema:
                type: object

  /funds/{id}/holdings:
    get:
      tags: [Funds]
      summary: Récupérer les holdings d'un fond
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Holdings du fond
          content:
            application/json:
              schema:
                type: object

  /funds/{id}/filings:
    get:
      tags: [Funds]
      summary: Récupérer les filings d'un fond
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Filings du fond
          content:
            application/json:
              schema:
                type: object

  # ============================================
  # COMPANIES
  # ============================================
  /companies:
    get:
      tags: [Companies]
      summary: Récupérer toutes les entreprises
      responses:
        '200':
          description: Liste des entreprises
          content:
            application/json:
              schema:
                type: object
                properties:
                  companies:
                    type: array
                    items:
                      type: object

    post:
      tags: [Companies]
      summary: Créer une entreprise
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Entreprise créée
          content:
            application/json:
              schema:
                type: object

  /companies/{id}:
    get:
      tags: [Companies]
      summary: Récupérer une entreprise par ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détails de l'entreprise
          content:
            application/json:
              schema:
                type: object

  /companies/ticker/{ticker}:
    get:
      tags: [Companies]
      summary: Récupérer une entreprise par ticker
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Détails de l'entreprise
          content:
            application/json:
              schema:
                type: object

  /companies/{id}/filings:
    get:
      tags: [Companies]
      summary: Récupérer les filings d'une entreprise
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: form_type
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Filings de l'entreprise
          content:
            application/json:
              schema:
                type: object

  /companies/{id}/events:
    get:
      tags: [Companies]
      summary: Récupérer les événements d'une entreprise
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: event_type
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Événements de l'entreprise
          content:
            application/json:
              schema:
                type: object

  /companies/{id}/insider-trades:
    get:
      tags: [Companies]
      summary: Récupérer les insider trades d'une entreprise
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Insider trades
          content:
            application/json:
              schema:
                type: object

  # ============================================
  # ECONOMIC CALENDAR
  # ============================================
  /economic-calendar:
    get:
      tags: [Analyse Combinée]
      summary: Récupérer le calendrier économique combiné (FMP + UW)
      parameters:
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Date de début (YYYY-MM-DD). Par défaut, aujourd'hui.
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Date de fin (YYYY-MM-DD). Par défaut, +30 jours.
      responses:
        '200':
          description: Calendrier économique
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object

  /13f-filings/latest:
    get:
      tags: [Analyse Combinée]
      summary: Récupérer les derniers 13F filings
      parameters:
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Derniers 13F filings
          content:
            application/json:
              schema:
                type: object

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Cognito

  schemas:
    OptionsFiveFactorsData:
      type: object
      description: >
        Payload structuré construit par le backend à partir des tables d'ingestion (DB-first).
        L'IA doit interpréter ces métriques sans inventer de données.
      properties:
        ticker:
          type: string
        as_of:
          type: string
          format: date
        recent_flows:
          type: object
          properties:
            direction:
              type: string
              enum: [bullish, bearish, neutral]
            call_volume:
              type: number
            put_volume:
              type: number
            call_put_ratio:
              type: number
            total_premium:
              type: number
            top_trades:
              type: array
              items:
                type: object
                properties:
                  option_symbol:
                    type: string
                  strike:
                    type: number
                    nullable: true
                  expiry:
                    type: string
                    nullable: true
                  type:
                    type: string
                    enum: [call, put, unknown]
                  volume:
                    type: number
                  premium:
                    type: number
                    nullable: true
                  executed_at:
                    type: string
                    nullable: true
        oi_change:
          type: object
          nullable: true
          properties:
            total_change:
              type: number
            call_oi_change:
              type: number
            put_oi_change:
              type: number
            top_increases:
              type: array
              items:
                type: object
                properties:
                  option_symbol:
                    type: string
                  strike:
                    type: number
                    nullable: true
                  expiry:
                    type: string
                    nullable: true
                  oi_diff_plain:
                    type: number
                  oi_change:
                    type: number
                    nullable: true
            top_decreases:
              type: array
              items:
                type: object
                properties:
                  option_symbol:
                    type: string
                  strike:
                    type: number
                    nullable: true
                  expiry:
                    type: string
                    nullable: true
                  oi_diff_plain:
                    type: number
                  oi_change:
                    type: number
                    nullable: true
        oi_per_strike:
          type: object
          nullable: true
          properties:
            top_strikes:
              type: array
              items:
                type: object
                properties:
                  strike:
                    type: number
                  call_oi:
                    type: number
                  put_oi:
                    type: number
                  total_oi:
                    type: number
        iv_rank:
          type: object
          nullable: true
          properties:
            latest_date:
              type: string
              format: date
            iv_rank_1y:
              type: number
              nullable: true
            volatility:
              type: number
              nullable: true
            close:
              type: number
              nullable: true
        max_pain:
          type: object
          nullable: true
          properties:
            current_spot:
              type: number
              nullable: true
            rows:
              type: array
              items:
                type: object
                properties:
                  expiry:
                    type: string
                  max_pain:
                    type: number
                  distance_from_spot:
                    type: number
                    nullable: true
            nearest_expiry:
              type: object
              nullable: true
              properties:
                expiry:
                  type: string
                max_pain:
                  type: number
                distance_from_spot:
                  type: number
                  nullable: true
        greeks_aggregated:
          type: object
          nullable: true
          description: >
            Greeks agrégés (exposition delta/gamma par strike) pour qualifier le contexte (gamma map / walls / pin).
            Ce n'est PAS un signal de trading.
          properties:
            as_of:
              type: string
              format: date
            net_gamma_exposure:
              type: number
              nullable: true
            net_delta_exposure:
              type: number
              nullable: true
            top_gamma_strikes:
              type: array
              items:
                type: object
                properties:
                  strike:
                    type: number
                  net_gamma_exposure:
                    type: number
                  call_gamma_exposure:
                    type: number
                  put_gamma_exposure:
                    type: number
                  net_delta_exposure:
                    type: number
                  call_delta_exposure:
                    type: number
                  put_delta_exposure:
                    type: number
        flow_context:
          type: object
          nullable: true
          description: >
            Contexte flow vs OI (ratios) pour qualifier hedge/roll vs conviction.
            Pas de recommandation directionnelle.
          properties:
            total_flow_volume:
              type: number
            total_flow_premium:
              type: number
            oi_change_total:
              type: number
              nullable: true
            flow_to_oi_change_ratio:
              type: number
              nullable: true
            top_strikes_total_oi:
              type: number
              nullable: true
            oi_concentration_ratio:
              type: number
              nullable: true
              description: "Concentration OI (top1_total_oi / sum(top10_total_oi))."
        flow_repetition:
          type: object
          nullable: true
          description: >
            Répétition du flow sur 1–3 jours (qualifie flow isolé vs flow répété).
          properties:
            unique_days:
              type: integer
            days:
              type: array
              items:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                  trades_count:
                    type: integer
                  premium_sum:
                    type: number
                  call_volume:
                    type: number
                  put_volume:
                    type: number
        price_context:
          type: object
          nullable: true
          properties:
            spot:
              type: number
              nullable: true
            change_percent:
              type: number
              nullable: true
            volume:
              type: number
              nullable: true
            sma_20:
              type: number
              nullable: true
            sma_50:
              type: number
              nullable: true
            stddev_20:
              type: number
              nullable: true
            range_5d_pct:
              type: number
              nullable: true
            distance_to_sma_20:
              type: number
              nullable: true
            distance_to_sma_50:
              type: number
              nullable: true
            trend_20_50:
              type: string
              enum: [up, down, flat, unknown]
            trend:
              type: string
              enum: [up, down, range, unknown]
              description: Price regime for options interpretation (not a trading signal)
            price_vs_sma20_pct:
              type: number
              nullable: true
              description: (spot - sma20) / sma20 * 100
            price_vs_sma50_pct:
              type: number
              nullable: true
              description: (spot - sma50) / sma50 * 100
            adx_14:
              type: number
              nullable: true
              description: ADX(14) trend strength indicator (context only)
            market_state:
              type: string
              enum: [trending, choppy, unknown]
            realized_vol_20d:
              type: number
              nullable: true
              description: Annualized realized volatility from 20 daily log returns (context only)
        catalysts:
          type: object
          nullable: true
          properties:
            next_earnings_date:
              type: string
              nullable: true
            report_time:
              type: string
              nullable: true
            days_to_earnings:
              type: integer
              nullable: true
            is_earnings_week:
              type: boolean
            expected_move_perc:
              type: number
              nullable: true
        dark_pool:
          type: object
          nullable: true
          properties:
            count:
              type: integer
            total_value:
              type: number
              nullable: true
            total_volume:
              type: number
              nullable: true
            avg_trade_size:
              type: number
              nullable: true
            vs_avg_30d_value:
              type: number
              nullable: true

    OptionsFiveFactorsAnalysisResponse:
      type: object
      description: >
        Analyse "radar options" non-directionnelle basée sur 5 facteurs (flows, OI, IV Rank, Max Pain).
        IMPORTANT : pas de recommandations de trade, pas de probabilités directionnelles, pas de price targets.
      properties:
        ticker:
          type: string
        observation:
          type: string
        interpretation:
          type: string
        signal_quality:
          type: string
          enum: [high, medium, low]
        dominant_intent:
          type: string
          enum: [hedging, speculation, gamma_management, mixed]
        evidence:
          type: array
          description: "Liste d'évidence (3–6 items) ancrée sur les métriques fournies. Ex: call_put_ratio=4.10"
          items:
            type: string
        data_quality:
          type: object
          description: "Qualité des données et debug (missing + staleness)."
          properties:
            missing:
              type: array
              items:
                type: string
            staleness:
              type: object
              properties:
                as_of:
                  type: string
                  format: date
                days_old:
                  type: integer
        risks:
          type: array
          items:
            type: string
        zones_to_watch:
          type: array
          items:
            type: object
            properties:
              label:
                type: string
              zone:
                type: string
              reason:
                type: string
        why_this_is_not_a_clear_signal:
          type: array
          items:
            type: string
        cached:
          type: boolean
        timestamp:
          type: string
          format: date-time

    ModuleState:
      type: object
      properties:
        ticker:
          type: string
          example: NVDA
        module_id:
          type: string
          example: options_flow
        status:
          type: string
          enum: [missing, refreshing, ready, error]
        fetched_at:
          type: string
          format: date-time
        data_date:
          type: string
          format: date
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
          properties:
            count:
              type: integer
            call_count:
              type: integer
            put_count:
              type: integer
            ingested_at:
              type: string
              format: date-time
        refresh_lock_until:
          type: string
          format: date-time
          nullable: true
        refresh_lock_owner:
          type: string
          nullable: true

    FlowOptionsSignal:
      type: object
      description: Signal de flow options à analyser
      properties:
        ticker:
          type: string
          example: MSFT
        type:
          type: string
          enum: [call, put]
          example: call
        strike:
          type: string
          example: "375"
        expiry:
          type: string
          format: date
          example: "2023-12-22"
        total_premium:
          type: number
          nullable: true
          example: 186705
        total_size:
          type: integer
          nullable: true
          example: 461
        trade_count:
          type: integer
          nullable: true
          example: 32
        volume:
          type: integer
          nullable: true
          example: 2442
        open_interest:
          type: integer
          nullable: true
          example: 7913
        volume_oi_ratio:
          type: number
          nullable: true
          example: 0.308
        underlying_price:
          type: number
          nullable: true
          example: 372.99
        alert_rule:
          type: string
          nullable: true
          example: RepeatedHits
        all_opening_trades:
          type: boolean
          nullable: true
        has_floor:
          type: boolean
          nullable: true
        has_sweep:
          type: boolean
          nullable: true
        has_multileg:
          type: boolean
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true

    FlowOptionsAnalysisProResponse:
      type: object
      description: Réponse d'analyse professionnelle du flow options
      properties:
        success:
          type: boolean
          example: true
        signals_analyzed:
          type: integer
          example: 1
        analyses:
          type: array
          items:
            type: object
            properties:
              signal:
                $ref: '#/components/schemas/FlowOptionsSignal'
              importance:
                type: object
                properties:
                  premium_significance:
                    type: string
                    enum: [significatif, marginal]
                  repetition:
                    type: boolean
                  concentration:
                    type: string
                    nullable: true
                  score:
                    type: integer
                    minimum: 0
                    maximum: 100
              market_intention:
                type: object
                properties:
                  flow_type:
                    type: string
                    enum: [directionnel, événementiel, indéterminé]
                  time_horizon:
                    type: string
                    enum: [court, moyen, long, indéterminé]
                  days_to_expiry:
                    type: integer
                    nullable: true
                  reasoning:
                    type: string
              credibility:
                type: object
                properties:
                  new_money_indicators:
                    type: string
                    enum: [fort, modéré, faible, indéterminé]
                  structure_complexity:
                    type: string
                    enum: [simple, potentiellement_complexe, complexe]
                  hedge_indicators:
                    type: array
                    items:
                      type: string
                    nullable: true
                  score:
                    type: integer
                    minimum: 0
                    maximum: 100
              conclusion:
                type: object
                properties:
                  action:
                    type: string
                    enum: [IGNORER, SURVEILLER, À_ANALYSER_DAVANTAGE]
                  reasoning:
                    type: string
                  key_factors:
                    type: array
                    items:
                      type: string
        summary:
          type: string
          nullable: true
          description: Synthèse globale si plusieurs signals
        cached:
          type: boolean
          example: false
        timestamp:
          type: string
          format: date-time

    IngestionResponse:
      type: object
      properties:
        success:
          type: boolean
        ticker:
          type: string
        module:
          type: string
        state:
          $ref: '#/components/schemas/ModuleState'
        timestamp:
          type: string
          format: date-time

    UnitAnalysisResult:
      type: object
      properties:
        module:
          type: string
        ticker:
          type: string
        data_date:
          type: string
          format: date
          nullable: true
        signals:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              score:
                type: number
              evidence:
                type: array
                items:
                  type: string
        summary:
          type: string
        confidence:
          type: number
        metrics:
          type: object
          properties:
            total_volume:
              type: number
            call_volume:
              type: number
            put_volume:
              type: number
            call_put_ratio:
              type: number
            total_premium:
              type: number
            data_count:
              type: integer

    AIAnalysis:
      type: object
      properties:
        warnings:
          type: array
          items:
            type: string
        scenarios:
          type: object
          properties:
            bearish:
              type: object
            bullish:
              type: object
            neutral:
              type: object
        observation:
          type: string
        key_insights:
          type: array
          items:
            type: object
        interpretation:
          type: string
        attention_level:
          type: string
        recommendations:
          type: array
          items:
            type: object
        strategy_hypothesis:
          type: object
        next_signals_to_watch:
          type: array
          items:
            type: string

    AIAnalysisResponse:
      type: object
      properties:
        success:
          type: boolean
        ticker:
          type: string
        analysis:
          $ref: '#/components/schemas/AIAnalysis'
        cached:
          type: boolean
          default: false
        timestamp:
          type: string
          format: date-time

    CombinedAnalysisResponse:
      type: object
      properties:
        ticker:
          type: string
        analysis:
          type: object
        timestamp:
          type: string
          format: date-time

    DivergenceAnalysisResponse:
      type: object
      properties:
        ticker:
          type: string
        divergences:
          type: array
          items:
            type: object
        timestamp:
          type: string
          format: date-time

    ValuationResponse:
      type: object
      properties:
        ticker:
          type: string
        valuation:
          type: object
        timestamp:
          type: string
          format: date-time

    EarningsPredictionResponse:
      type: object
      properties:
        ticker:
          type: string
        prediction:
          type: object
        timestamp:
          type: string
          format: date-time

    RiskAnalysisResponse:
      type: object
      properties:
        ticker:
          type: string
        risk_analysis:
          type: object
        timestamp:
          type: string
          format: date-time

